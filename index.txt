<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>English Buddy Game</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Outfit:wght@400;600;800&display=swap');
        body { font-family: 'Outfit', sans-serif; background: #0f172a; color: white; }
        .game-card { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.1); }
        .pulse-mic { animation: pulse 1.5s infinite; background: #ef4444 !important; }
        @keyframes pulse {
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            70% { transform: scale(1.05); box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
            100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">
    <div id="root" class="w-full max-w-lg"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const apiKey = ""; // API Key handled by environment
        const MODEL_URL = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent";
        const TTS_URL = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent";

        const TOPICS = [
            { id: 'survival', name: 'Zombies!', emoji: 'ðŸ§Ÿ', prompt: 'a zombie apocalypse survivor' },
            { id: 'space', name: 'Alien Meet', emoji: 'ðŸ‘½', prompt: 'an alien trying to learn about Earth' },
            { id: 'chef', name: 'Master Chef', emoji: 'ðŸ‘¨â€ðŸ³', prompt: 'a world-class chef testing my skills' },
            { id: 'magic', name: 'Wizard School', emoji: 'ðŸ§™â€â™‚ï¸', prompt: 'a magic teacher at a secret academy' }
        ];

        function App() {
            const [step, setStep] = useState('menu');
            const [messages, setMessages] = useState([]);
            const [inputValue, setInputValue] = useState('');
            const [isListening, setIsListening] = useState(false);
            const [isLoading, setIsLoading] = useState(false);
            const [score, setScore] = useState(0);
            
            const recognitionRef = useRef(null);
            const chatEndRef = useRef(null);

            useEffect(() => {
                if (window.lucide) window.lucide.createIcons();
                chatEndRef.current?.scrollIntoView({ behavior: "smooth" });
            }, [messages, isListening]);

            // Audio Logic
            const playVoice = async (text) => {
                const clean = text.replace(/\(.*?\)/g, '').trim();
                try {
                    const res = await fetch(`${TTS_URL}?key=${apiKey}`, {
                        method: 'POST',
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: clean }] }],
                            generationConfig: { 
                                responseModalities: ["AUDIO"], 
                                speechConfig: { voiceConfig: { prebuiltVoiceConfig: { voiceName: "Puck" } } } 
                            },
                            model: "gemini-2.5-flash-preview-tts"
                        })
                    });
                    const data = await res.json();
                    const b64 = data.candidates?.[0]?.content?.parts?.[0]?.inlineData?.data;
                    if (b64) new Audio("data:audio/wav;base64," + b64).play();
                } catch (e) {}
            };

            // Mic Logic
            const toggleMic = () => {
                const SpeechRec = window.SpeechRecognition || window.webkitSpeechRecognition;
                if (!SpeechRec) return alert("Mic not supported in this browser");

                if (!recognitionRef.current) {
                    recognitionRef.current = new SpeechRec();
                    recognitionRef.current.continuous = false;
                    recognitionRef.current.lang = 'en-US';
                    recognitionRef.current.onstart = () => setIsListening(true);
                    recognitionRef.current.onend = () => setIsListening(false);
                    recognitionRef.current.onresult = (e) => setInputValue(e.results[0][0].transcript);
                }

                if (isListening) recognitionRef.current.stop();
                else recognitionRef.current.start();
            };

            const handleAction = async (topic = null, text = null) => {
                const currentText = text || inputValue;
                if (!currentText && !topic) return;

                setIsLoading(true);
                const userMsg = { role: 'user', text: currentText || `Let's start the game!` };
                const newMsgs = [...messages, userMsg];
                if (currentText) setMessages(newMsgs);
                setInputValue('');
                if (currentText) setScore(s => s + 10);

                const sysPrompt = `You are playing a roleplay game with an English student. You are ${topic?.prompt || 'a helpful tutor'}. 
                1. Stay in character. 
                2. Use A2 English. 
                3. Add Spanish translation in (). 
                4. End with a question.`;

                try {
                    const res = await fetch(`${MODEL_URL}?key=${apiKey}`, {
                        method: 'POST',
                        body: JSON.stringify({
                            contents: newMsgs.map(m => ({ role: m.role, parts: [{ text: m.text }] })),
                            systemInstruction: { parts: [{ text: sysPrompt }] }
                        })
                    });
                    const data = await res.json();
                    const aiText = data.candidates[0].content.parts[0].text;
                    setMessages([...newMsgs, { role: 'model', text: aiText }]);
                    playVoice(aiText);
                } catch (e) {} finally { setIsLoading(false); }
            };

            if (step === 'menu') {
                return (
                    <div className="game-card p-8 rounded-3xl text-center shadow-2xl">
                        <h1 className="text-4xl font-extrabold mb-2 text-transparent bg-clip-text bg-gradient-to-r from-indigo-400 to-cyan-400">English Quest</h1>
                        <p className="text-slate-400 text-sm mb-8 font-medium">Choose your adventure to start practicing!</p>
                        <div className="grid grid-cols-1 gap-4 text-left">
                            {TOPICS.map(t => (
                                <button key={t.id} onClick={() => {setStep('game'); handleAction(t);}} className="flex items-center gap-4 p-4 rounded-2xl bg-white/5 hover:bg-white/10 border border-white/10 hover:border-indigo-500 transition-all group">
                                    <span className="text-3xl">{t.emoji}</span>
                                    <div>
                                        <div className="font-bold text-white">{t.name}</div>
                                        <div className="text-xs text-slate-400">Survival Roleplay</div>
                                    </div>
                                    <i data-lucide="play" className="ml-auto w-5 h-5 text-indigo-400 group-hover:translate-x-1 transition-transform"></i>
                                </button>
                            ))}
                        </div>
                    </div>
                );
            }

            return (
                <div className="game-card rounded-3xl flex flex-col h-[700px] overflow-hidden shadow-2xl">
                    <div className="p-4 bg-white/5 border-b border-white/10 flex justify-between items-center">
                        <div className="flex items-center gap-2">
                            <span className="bg-indigo-500 text-xs font-black px-2 py-1 rounded">LVL 1</span>
                            <span className="text-sm font-bold">XP: {score}</span>
                        </div>
                        <button onClick={() => {setStep('menu'); setMessages([]); setScore(0);}} className="text-[10px] font-bold text-slate-400 hover:text-white uppercase tracking-widest">Quit Game</button>
                    </div>

                    <div className="flex-1 overflow-y-auto p-4 space-y-4 hide-scrollbar">
                        {messages.map((m, i) => (
                            <div key={i} className={`flex ${m.role === 'user' ? 'justify-end' : 'justify-start'}`}>
                                <div className={`max-w-[85%] p-4 rounded-2xl text-sm ${m.role === 'user' ? 'bg-indigo-600 rounded-tr-none' : 'bg-slate-800 border border-white/5 rounded-tl-none'}`}>
                                    {m.text.split('\n').map((l, idx) => (
                                        <p key={idx} className={l.includes('(') ? 'text-indigo-300 italic text-xs mt-2 border-t border-white/5 pt-2' : ''}>{l}</p>
                                    ))}
                                </div>
                            </div>
                        ))}
                        {isLoading && <div className="text-xs text-indigo-400 animate-pulse font-bold uppercase tracking-widest">The Buddy is typing...</div>}
                        <div ref={chatEndRef} />
                    </div>

                    <div className="p-4 bg-black/20 border-t border-white/10 space-y-3">
                        <div className="flex gap-2">
                            <button onClick={toggleMic} className={`p-4 rounded-2xl transition-all border border-white/10 ${isListening ? 'pulse-mic' : 'bg-white/5 text-slate-400 hover:text-white'}`}>
                                <i data-lucide={isListening ? "mic" : "mic-off"} className="w-6 h-6"></i>
                            </button>
                            <input 
                                value={inputValue} 
                                onChange={e => setInputValue(e.target.value)} 
                                onKeyDown={e => e.key === 'Enter' && handleAction()}
                                placeholder={isListening ? "Listening..." : "Type your message..."}
                                className="flex-1 bg-white/5 border border-white/10 rounded-2xl px-4 text-sm focus:outline-none focus:border-indigo-500 transition-colors"
                            />
                            <button onClick={() => handleAction()} className="p-4 bg-indigo-600 rounded-2xl hover:bg-indigo-500 transition-all shadow-lg shadow-indigo-500/20">
                                <i data-lucide="send" className="w-5 h-5 text-white"></i>
                            </button>
                        </div>
                        <p className="text-[9px] text-center text-slate-500 font-bold uppercase tracking-widest">Practice speaking or typing to earn XP!</p>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
